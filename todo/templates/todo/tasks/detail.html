<!-- todo/templates/todo/tasks/detail.html -->
{% extends "base.html" %}

{% load custom_filters %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<div class="task-detail">
    <h2>{{ task.title }}</h2>
    <div class="task-info">
        <div class="info-item">
            <strong>Исполнитель:</strong> {{ task.assignee.first_name }}
        </div>
        <div class="info-item">
            <strong>Создал:</strong> {{ task.created_by.first_name|default:"—" }}
        </div>
        <div class="info-item">
            <strong>Статус:</strong> {{ task.get_status_display }}
        </div>
        <div class="info-item">
            <strong>Приоритет:</strong> {{ task.get_priority_display }}
        </div>
        <div class="info-item">
            <strong>Дедлайн:</strong> {{ task.deadline|date:"d.m.Y H:i" }}
        </div>
        <div class="info-item">
            <strong>Создана:</strong> {{ task.created_at|date:"d.m.Y H:i" }}
        </div>
        <div class="info-item">
            <strong>Описание:</strong> {{ task.description|linebreaks|default:"—" }}
        </div>
        <div class="info-item">
        {% if task.files.exists %}
            <div class="info-item">
                <strong>Файлы:</strong>
                <ul>
                {% for file in task.files.all %}
                    <li>
                    <a href="{{ file.file.url }}" target="_blank">
                        Скачать {{ file.file.name|basename }}
                    </a>
                    </li>
                {% endfor %}
                </ul>
            </div>
        {% endif %}
        </div>
    </div>

    <h3>История изменений</h3>
    <ul class="history-list">
    {% for entry in task.history.all %}
        <li class="history-entry">
            <span class="entry-time">{{ entry.changed_at|date:"d.m.Y H:i" }}</span>
            <span class="entry-user">{{ entry.changed_by.username|default:"Система" }}</span>
            <span class="entry-field">{{ entry.field_changed }}</span>
            <span class="entry-change">«{{ entry.old_value|default:"—" }}» → «{{ entry.new_value|default:"—" }}»</span>
            {% if entry.reason %}
                <span class="entry-reason">({{ entry.reason }})</span>
            {% endif %}
        </li>
    {% empty %}
        <li>Изменений нет</li>
    {% endfor %}
    </ul>

    <div class="task-actions">
        <a href="{% url 'todo:task_list' %}" class="btn btn-secondary">Назад к списку</a>
        <a href="{% url 'todo:task_update' task.pk %}" class="btn btn-warning">Редактировать</a>
        <a href="{% url 'todo:task_delete' task.pk %}" class="btn btn-danger">Удалить</a>
    </div>
</div>
{% endblock %}