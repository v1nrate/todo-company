<!-- todo/templates/todo/tasks/detail.html -->
{% extends "base.html" %}

{% load custom_filters %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<div class="task-detail">
    <h2>{{ task.title }}</h2>
    <div class="task-info">
        <div class="info-item">
            <strong>Исполнитель:</strong> {{ task.assignee.first_name }}
        </div>
        <div class="info-item">
            <strong>Создал:</strong> {{ task.created_by.first_name|default:"—" }}
        </div>
        <div class="info-item">
            <strong>Статус:</strong> {{ task.get_status_display }}
        </div>
        <div class="info-item">
            <strong>Приоритет:</strong> {{ task.get_priority_display }}
        </div>
        <div class="info-item">
            <strong>Дедлайн:</strong> {{ task.deadline|date:"d.m.Y H:i" }}
        </div>
        <div class="info-item">
            <strong>Создана:</strong> {{ task.created_at|date:"d.m.Y H:i" }}
        </div>
        <div class="info-item">
            <strong>Описание:</strong> {{ task.description|linebreaks|default:"—" }}
        </div>
        <div class="info-item">
        {% if task.files.exists %}
            <div class="info-item">
                <strong>Файлы:</strong>
                <ul>
                {% for file in task.files.all %}
                    <li>
                    <a href="{{ file.file.url }}" target="_blank">
                        Скачать {{ file.file.name|basename }}
                    </a>
                    </li>
                {% endfor %}
                </ul>
            </div>
        {% endif %}
        </div>
    </div>

    <!-- Комментарии -->
    <div class="comments-section" style="margin-top: 2rem;">
        <h3>Комментарии ({{ task.comments.count }})</h3>

        <!-- Форма добавления -->
        <form method="post" autocomplete="off">
            {% csrf_token %}
            {{ comment_form.text|attr:"autocomplete:off" }}
            <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">Добавить комментарий</button>
        </form>

        <!-- Список комментариев -->
        {% if task.comments.exists %}
            <div class="comments-list">
                {% for comment in task.comments.all|dictsortreversed:"created_at" %}
                <div class="comment-card" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #6c5ce7;">
                    <div style="font-weight: 600; color: #6c5ce7;">{{ comment.author.first_name }}</div>
                    <div style="font-size: 0.95rem; margin: 6px 0;">{{ comment.text|linebreaks }}</div>
                    <div style="font-size: 0.85rem; color: #888;">
                        {{ comment.created_at|date:"d.m.Y H:i" }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>Комментариев пока нет.</p>
        {% endif %}
    </div>

    <div class="task-actions">
        <a href="{% url 'todo:task_list' %}" class="btn btn-secondary">Назад к списку</a>
        <a href="{% url 'todo:task_update' task.pk %}" class="btn btn-warning">Редактировать</a>
        <a href="{% url 'todo:task_delete' task.pk %}" class="btn btn-danger">Удалить</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const textarea = document.querySelector('textarea[name="text"]');
    if (textarea && urlParams.has('comment')) {
        textarea.value = '';
    }
});
</script>
{% endblock %}