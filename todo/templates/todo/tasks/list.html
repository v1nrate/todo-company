<!-- todo/templates/todo/tasks/list.html -->
{% extends "base.html" %}

{% block title %}Задачи{% endblock %}

{% block content %}
<div class="tasks-page">
    <!-- Левое меню -->
    <aside class="sidebar">
        <div class="menu-section">
            <h3 class="section-title"><i class="fas fa-bars"></i> Меню</h3>
            <ul class="menu-list">
                <li><a href="{% url 'todo:task_list' %}" class="active"><i class="fas fa-tasks"></i> Задачи</a></li>
                <li><a href="{% url 'todo:user_list' %}"><i class="fas fa-users"></i> Команда</a></li>
                <li><a href="{% url 'todo:history_list' %}"><i class="fas fa-history"></i> История</a></li>
            </ul>
        </div>
    </aside>

    <!-- Основной контент -->
    <main class="tasks-main">
        <!-- Верхняя панель -->
        <div class="header-actions">
            <a href="{% url 'todo:task_create' %}" class="btn btn-action">+ Добавить задачу</a>
            
            <!-- Раскрывающийся список сортировки -->
            <div class="sort-dropdown">
                <label>Сортировать по:</label>
                <select id="sort-select" onchange="applySort()">
                    <option value="">— Выберите —</option>
                    <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>Создана ↓</option>
                    <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>Создана ↑</option>
                    <option value="-deadline" {% if request.GET.sort == '-deadline' %}selected{% endif %}>Дедлайн ↓</option>
                    <option value="deadline" {% if request.GET.sort == 'deadline' %}selected{% endif %}>Дедлайн ↑</option>
                    {% if request.user.role == 'manager' %}
                    <option value="assignee__first_name" {% if request.GET.sort == 'assignee__first_name' %}selected{% endif %}>Исполнитель ↑</option>
                    <option value="-assignee__first_name" {% if request.GET.sort == '-assignee__first_name' %}selected{% endif %}>Исполнитель ↓</option>
                    {% endif %}
                    <option value="priority" {% if request.GET.sort == 'priority' %}selected{% endif %}>Приоритет</option>
                    <option value="status" {% if request.GET.sort == 'status' %}selected{% endif %}>Статус</option>
                </select>
            </div>
        </div>

        <!-- Два столбца: задачи + календарь -->
        <div class="content-wrapper">
            <div class="tasks-column">
                <div class="tasks-list" id="tasks-container">
                    <div class="no-tasks">Загрузка задач...</div>
                </div>

                {% if is_paginated %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                    <a href="?page=1">&laquo; первая</a>
                    <a href="?page={{ page_obj.previous_page_number }}">предыдущая</a>
                    {% endif %}
                    <span>Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}">следующая</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}">последняя &raquo;</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="calendar-column">
                <div class="calendar-widget">
                    <h4>Календарь</h4>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function applySort() {
    const sortValue = document.getElementById('sort-select').value;
    let url = new URL(window.location);
    if (sortValue) {
        url.searchParams.set('sort', sortValue);
    } else {
        url.searchParams.delete('sort');
    }
    window.location.href = url.toString();
}

function loadTasks() {
    const url = new URL(window.location);
    const sortParam = url.searchParams.get('sort');
    const apiEndpoint = "{% url 'todo:api_tasks' %}" + (sortParam ? `?sort=${encodeURIComponent(sortParam)}` : '');

    fetch(apiEndpoint)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('tasks-container');
            let html = '';
            if (data.tasks.length === 0) {
                html = '<div class="no-tasks">Нет активных задач</div>';
            } else {
                data.tasks.forEach(task => {
                    const statusClass = task.status === 'completed' ? 'task-completed' : 
                                       task.status === 'overdue' ? 'task-overdue' : '';
                    
                    html += `
                        <div class="task-card ${statusClass}" data-task-id="${task.id}">
                            <div class="task-header">
                                <div class="task-title">
                                    ${task.status === 'overdue' ? '<span>[Просрочено]</span> ' : ''}
                                    ${task.title}
                                </div>
                                <span class="task-priority priority-${task.priority}">${task.priority_display}</span>
                            </div>
                            <div class="task-description">${task.description || "—"}</div>
                            <div class="task-footer">
                                <div class="task-meta">
                                    <span>Дедлайн: ${task.deadline}</span>
                                    <span>Создал: ${task.created_by__first_name || "—"}</span>
                                    ${data.user_is_manager ? `<span>Исполнитель: ${task.assignee__first_name || "—"}</span>` : ''}
                                </div>
                                <div class="task-actions">
                                    <a href="/tasks/${task.id}/edit/" class="btn btn-action">Редактировать</a>
                                    <a href="/tasks/${task.id}/complete/" class="btn btn-action">Завершить</a>
                                </div>
                            </div>
                        </div>`;
                });
            }
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Ошибка обновления задач:', error);
            document.getElementById('tasks-container').innerHTML = '<div class="no-tasks">Ошибка загрузки</div>';
        });
}

// Загрузить задачи
loadTasks();

// Обновлять каждые 5 секунд
setInterval(loadTasks, 5000);

document.getElementById('tasks-container').addEventListener('click', function(e) {
    // Находим ближайший элемент с классом .task-card
    const taskCard = e.target.closest('.task-card');
    // Игнорируем клик, если он был по кнопке "Редактировать" или "Завершить"
    if (e.target.closest('.btn-edit') || e.target.closest('.btn-complete')) {
        return;
    }
    // Если клик был по карточке задачи
    if (taskCard) {
        const taskId = taskCard.dataset.taskId;
        if (taskId) {
            window.location.href = `/tasks/${taskId}/`;
        }
    }
});

// Календарь
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const eventsLoader = function(fetchInfo, successCallback, failureCallback) {
        fetch('{% url "todo:calendar_events" %}')
            .then(response => response.json())
            .then(events => {
                successCallback(events);
            })
            .catch(failureCallback);
    };

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ru',
        timeZone: 'Europe/Moscow',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
        },
        events: eventsLoader,
        eventContent: function(arg) {
            const timeText = arg.event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return {
                html: `<div style="font-size: 0.8em; padding: 2px 4px; background-color: ${arg.event.backgroundColor}; color: white; border-radius: 3px;">
                    ${timeText}
                </div>`
            };
        },
        height: 'auto',
        aspectRatio: false,
        scrollTime: '00:00:00',
        dayMaxEvents: false
    });
    calendar.render();
});
</script>
{% endblock %}