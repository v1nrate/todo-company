<!-- todo/templates/todo/tasks/list.html -->
{% extends "base.html" %}

{% block title %}Задачи{% endblock %}

{% block content %}
<div class="dashboard">
    <aside class="sidebar">
        <h3>Меню</h3>
        <ul>
            <li><a href="{% url 'todo:task_list' %}" class="active">Задачи</a></li>
            <li><a href="{% url 'todo:user_list' %}">Пользователи</a></li>
            <li><a href="{% url 'todo:history_list' %}">История</a></li>
        </ul>
    </aside>

    <div class="main-content">
        <div class="header-actions">
            <a href="{% url 'todo:task_create' %}" class="btn btn-primary">Добавить задачу</a>
            <div class="sort-controls" style="margin-bottom: 1rem;">
                <strong>Сортировать по:</strong>
                <a href="?sort=-created_at" class="btn {% if request.GET.sort == '-created_at' %}btn-primary{% else %}btn-outline{% endif %}">Создана ↓</a>
                <a href="?sort=created_at" class="btn {% if request.GET.sort == 'created_at' %}btn-primary{% else %}btn-outline{% endif %}">Создана ↑</a>
                <a href="?sort=-deadline" class="btn {% if request.GET.sort == '-deadline' %}btn-primary{% else %}btn-outline{% endif %}">Дедлайн ↓</a>
                <a href="?sort=deadline" class="btn {% if request.GET.sort == 'deadline' %}btn-primary{% else %}btn-outline{% endif %}">Дедлайн ↑</a>
                <a href="?sort=assignee__first_name" class="btn {% if request.GET.sort == 'assignee__first_name' %}btn-primary{% else %}btn-outline{% endif %}">Исполнитель ↑</a>
                <a href="?sort=-assignee__first_name" class="btn {% if request.GET.sort == '-assignee__first_name' %}btn-primary{% else %}btn-outline{% endif %}">Исполнитель ↓</a>
                <a href="?sort=priority" class="btn {% if request.GET.sort == 'priority' %}btn-primary{% else %}btn-outline{% endif %}">Приоритет</a>
                <a href="?sort=status" class="btn {% if request.GET.sort == 'status' %}btn-primary{% else %}btn-outline{% endif %}">Статус</a>
            </div>
            <div class="calendar-widget">
                <!-- Здесь будет календарь (FullCalendar.js) -->
                <h4>Календарь</h4>
                <div id="calendar"></div>
            </div>
        </div>

        <div class="tasks-list" id="tasks-container">
            <!-- Список задач будет обновляться здесь -->
            {% include "todo/tasks/_task_list_items.html" %}
        </div>

        {% if is_paginated %}
          <div class="pagination">
            {% if page_obj.has_previous %}
              <a href="?page=1">&laquo; первая</a>
              <a href="?page={{ page_obj.previous_page_number }}">предыдущая</a>
            {% endif %}
            <span>Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}">следующая</a>
              <a href="?page={{ page_obj.paginator.num_pages }}">последняя &raquo;</a>
            {% endif %}
          </div>
        {% endif %}
    </div>
</div>

<script>
function loadTasks() {
    const url = new URL(window.location);
    const sortParam = url.searchParams.get('sort');
    const apiEndpoint = "{% url 'todo:api_tasks' %}" + (sortParam ? `?sort=${encodeURIComponent(sortParam)}` : '');

    fetch(apiEndpoint)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('tasks-container');
            let html = '<ul>';
            data.tasks.forEach(task => {
                const statusClass = task.status === 'completed' ? 'completed' : task.status === 'overdue' ? 'overdue' : '';
                html += `
                    <li class="task-card ${statusClass}">
                        <div class="task-header">
                            <span class="task-title">${task.title}</span>
                            <span class="task-priority priority-${task.priority}">${task.priority_display}</span>
                        </div>
                        <div class="task-meta">
                            <span>Создал: ${task.created_by__first_name || "—"}</span>`;
                // Показываем исполнителя только если пользователь — менеджер
                if (data.user_is_manager) {
                    html += `<span>Исполнитель: ${task.assignee__first_name || "—"}</span>`;
                }
                html += `
                            <span>Дедлайн: ${task.deadline}</span>
                            <span>Статус: ${task.status_display}</span>
                        </div>
                        <div class="task-actions">
                            <a href="/tasks/${task.id}/">Подробнее</a>
                            <a href="/tasks/${task.id}/edit/">Редактировать</a>
                            <a href="/tasks/${task.id}/complete/" class="btn btn-sm btn-success">Завершить</a>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        })
        .catch(error => console.error('Ошибка обновления задач:', error));
}

// Загрузить задачи сразу
loadTasks();

// Обновлять каждые 5 секунд
setInterval(loadTasks, 5000);
</script>
{% endblock %}