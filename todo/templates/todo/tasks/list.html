<!-- todo/templates/todo/tasks/list.html -->
{% extends "base.html" %}

{% block title %}Задачи{% endblock %}

{% block content %}
<div class="dashboard">
    <aside class="sidebar">
        <h3>Меню</h3>
        <ul>
            <li><a href="{% url 'todo:task_list' %}" class="active">Задачи</a></li>
            <li><a href="{% url 'todo:user_list' %}">Пользователи</a></li>
            <li><a href="{% url 'todo:history_list' %}">История</a></li>
            <li><a href="{% url 'todo:telegram_user_list' %}">Telegram</a></li>
        </ul>
    </aside>

    <div class="main-content">
        <div class="header-actions">
            <a href="{% url 'todo:task_create' %}" class="btn btn-primary">Добавить задачу</a>
            <div class="calendar-widget">
                <!-- Здесь будет календарь (FullCalendar.js) -->
                <h4>Календарь</h4>
                <div id="calendar"></div>
            </div>
        </div>

        <div class="tasks-list" id="tasks-container">
            <!-- Список задач будет обновляться здесь -->
            {% include "todo/tasks/_task_list_items.html" %}
        </div>

        {% if is_paginated %}
          <div class="pagination">
            {% if page_obj.has_previous %}
              <a href="?page=1">&laquo; первая</a>
              <a href="?page={{ page_obj.previous_page_number }}">предыдущая</a>
            {% endif %}
            <span>Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}">следующая</a>
              <a href="?page={{ page_obj.paginator.num_pages }}">последняя &raquo;</a>
            {% endif %}
          </div>
        {% endif %}
    </div>
</div>

<script>
function loadTasks() {
    fetch("{% url 'todo:api_tasks' %}")
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('tasks-container');
            let html = '<ul>';
            data.tasks.forEach(task => {
                html += `
                    <li class="task-card ${task.status === 'completed' ? 'completed' : task.status === 'overdue' ? 'overdue' : ''}">
                        <div class="task-header">
                            <span class="task-title">${task.title}</span>
                            <span class="task-priority priority-${task.priority}">${task.priority_display}</span>
                        </div>
                        <div class="task-meta">
                            <span>Создал: ${task.created_by__first_name || "—"}</span>
                            <span>Дедлайн: ${task.deadline}</span>
                            <span>Статус: ${task.status_display}</span>
                        </div>
                        <div class="task-actions">
                            <a href="/tasks/${task.id}/">Подробнее</a>
                            <a href="/tasks/${task.id}/edit/">Редактировать</a>
                            <a href="/tasks/${task.id}/delete/" class="btn btn-sm btn-danger">Удалить</a>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        })
        .catch(error => console.error('Ошибка обновления задач:', error));
}

// Загрузить задачи сразу
loadTasks();

// Обновлять каждые 5 секунд
setInterval(loadTasks, 5000);
</script>
{% endblock %}