<!-- todo/templates/todo/tasks/create.html -->
{% extends "base.html" %}

{% block title %}Новая задача{% endblock %}

{% block content %}
<div class="task-create-page">
    <aside class="sidebar">
        <div class="menu-section">
            <h3 class="section-title"><i class="fas fa-bars"></i> Меню</h3>
            <ul class="menu-list">
                <li><a href="{% url 'todo:task_list' %}"><i class="fas fa-tasks"></i> Задачи</a></li>
                <li><a href="{% url 'todo:user_list' %}"><i class="fas fa-users"></i> Команда</a></li>
                <li><a href="{% url 'todo:history_list' %}"><i class="fas fa-history"></i> История</a></li>
            </ul>
        </div>
    </aside>

    <main class="tasks-main">
        <h2 class="page-title">Создать задачу</h2>

        <div class="task-card">
            <!-- ОБЫЧНАЯ ФОРМА — БЕЗ JS-ОТПРАВКИ -->
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Поля -->
                <div class="form-group">
                    <label>Заголовок</label>
                    {{ form.title }}
                    {% if form.title.errors %}<div class="error">{{ form.title.errors }}</div>{% endif %}
                </div>

                <div class="form-group">
                    <label>Описание</label>
                    {{ form.description }}
                    {% if form.description.errors %}<div class="error">{{ form.description.errors }}</div>{% endif %}
                </div>

                <div class="form-group">
                    <label>Исполнитель</label>
                    {{ form.assignee }}
                    {% if form.assignee.errors %}<div class="error">{{ form.assignee.errors }}</div>{% endif %}
                </div>

                <div class="form-group">
                    <label>Приоритет</label>
                    {{ form.priority }}
                    {% if form.priority.errors %}<div class="error">{{ form.priority.errors }}</div>{% endif %}
                </div>

                <div class="form-group">
                    <label>Дедлайн</label>
                    {{ form.deadline }}
                    {% if form.deadline.errors %}<div class="error">{{ form.deadline.errors }}</div>{% endif %}
                </div>

                <!-- Файлы -->
                <div class="form-group">
                    <label>Файлы</label>
                    <input type="file" name="files" multiple id="file-input">
                    <div id="file-list"></div>
                </div>

                <!-- Кнопки -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Сохранить задачу</button>
                    <a href="{{ request.META.HTTP_REFERER|default:'/tasks/' }}" class="btn btn-outline-secondary">Отмена</a>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
let selectedFiles = [];

document.getElementById('file-input').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    selected_files = selected_files.concat(files); // ❌ ОШИБКА: selected_files вместо selectedFiles!
    renderFileList();
    e.target.value = '';
});

function renderFileList() {
    const list = document.getElementById('file-list');
    list.innerHTML = '';
    selectedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `<span>${file.name}</span> <button type="button" onclick="removeFile(${index})">Удалить</button>`;
        list.appendChild(item);
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
}
</script>
{% endblock %}