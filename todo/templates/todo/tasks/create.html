{% extends "base.html" %}

{% load custom_filters %}

{% block title %}Новая задача{% endblock %}

{% block content %}
<h3>Создать задачу</h3>
<!-- todo/templates/todo/tasks/create.html -->

<form id="task-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  
  <!-- Остальные поля формы -->
  {{ form.as_p }}

  <!-- Блок для отображения выбранных файлов -->
  <div class="form-group">
    <label>Файлы:</label>
    <input type="file" id="file-input" multiple>
    <div id="file-list"></div>
  </div>

  <button type="submit" class="btn btn-primary">Сохранить задачу</button>
  <a href="{{ request.META.HTTP_REFERER|default:'/tasks/' }}" class="btn btn-outline-secondary">Отмена</a>
</form>

<script>
  let selectedFiles = [];

  document.getElementById('file-input').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    selectedFiles = selectedFiles.concat(files);
    renderFileList();
    // Очищаем input, чтобы можно было выбирать те же файлы снова
    e.target.value = '';
  });

  function renderFileList() {
    const list = document.getElementById('file-list');
    list.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const item = document.createElement('div');
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.margin = '0.3rem 0';

      const name = document.createElement('span');
      name.textContent = file.name;

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Удалить';
      deleteBtn.style.marginLeft = '1rem';
      deleteBtn.style.padding = '0.2rem 0.5rem';
      deleteBtn.style.cursor = 'pointer';
      deleteBtn.onclick = () => {
        selectedFiles.splice(index, 1);
        renderFileList();
      };

      item.appendChild(name);
      item.appendChild(deleteBtn);
      list.appendChild(item);
    });
  }

  // Перед отправкой формы — добавляем файлы в FormData
  document.getElementById('task-form').addEventListener('submit', function(e) {
    const formData = new FormData(this);
    
    // Удаляем возможные старые файлы из формы (если были)
    for (let pair of formData.entries()) {
      if (pair[0] === 'files') {
        formData.delete('files');
      }
    }

    // Добавляем все выбранные файлы
    selectedFiles.forEach(file => {
      formData.append('files', file);
    });

    // Отправляем форму вручную
    e.preventDefault();
    fetch(this.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        return response.text().then(html => {
          document.open();
          document.write(html);
          document.close();
        });
      }
    })
    .catch(err => console.error('Ошибка:', err));
  });
</script>

{% endblock %}